input {
  # TCP input for application logs
  tcp {
    port => 5000
    codec => json
    tags => ["application"]
  }

  # UDP input for syslog
  udp {
    port => 5000
    codec => json
    tags => ["application"]
  }

  # HTTP input for direct log shipping
  http {
    port => 8080
    codec => json
    tags => ["http"]
  }
}

filter {
  # Parse timestamp
  date {
    match => ["timestamp", "ISO8601", "YYYY-MM-dd HH:mm:ss:ms"]
    target => "@timestamp"
  }

  # Add geoip data for IP addresses
  if [ip] {
    geoip {
      source => "ip"
      target => "geoip"
    }
  }

  # Parse error stack traces
  if [stack] {
    mutate {
      gsub => ["stack", "\n", " | "]
    }
  }

  # Add service metadata
  mutate {
    add_field => {
      "[@metadata][index]" => "survey-logs-%{+YYYY.MM.dd}"
    }
  }

  # Classify log severity
  if [level] == "error" {
    mutate {
      add_field => { "severity" => "critical" }
      add_tag => ["alert"]
    }
  } else if [level] == "warn" {
    mutate {
      add_field => { "severity" => "warning" }
    }
  } else {
    mutate {
      add_field => { "severity" => "info" }
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}"
    document_type => "_doc"
  }

  # Debug output (disable in production)
  # stdout {
  #   codec => rubydebug
  # }
}

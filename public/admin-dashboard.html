<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - System Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar h2 {
            margin-bottom: 30px;
            font-size: 24px;
            color: #ecf0f1;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 10px;
        }

        .nav-menu a {
            display: block;
            color: #ecf0f1;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-menu a:hover, .nav-menu a.active {
            background: #34495e;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #2c3e50;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }

        .stat-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-healthy {
            background: #27ae60;
        }

        .status-degraded {
            background: #f39c12;
        }

        .status-unhealthy {
            background: #e74c3c;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>Admin Panel</h2>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-tab="overview">Dashboard Overview</a></li>
                <li><a href="#" data-tab="health">System Health</a></li>
                <li><a href="#" data-tab="users">User Management</a></li>
                <li><a href="#" data-tab="audit">Audit Logs</a></li>
                <li><a href="#" data-tab="settings">System Settings</a></li>
                <li><a href="#" data-tab="backup">Backup & Restore</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 id="page-title">Dashboard Overview</h1>
                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="card stat-card">
                        <div>
                            <div class="stat-value" id="total-users">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div>
                            <div class="stat-value" id="active-users">0</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div>
                            <div class="stat-value" id="system-status">Unknown</div>
                            <div class="stat-label">System Status</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div>
                            <div class="stat-value" id="cpu-usage">0%</div>
                            <div class="stat-label">CPU Usage</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Recent Activity</h3>
                    <div id="recent-activity" class="loading">
                        <div class="spinner"></div>
                        <p>Loading recent activity...</p>
                    </div>
                </div>
            </div>

            <!-- Health Tab -->
            <div id="health" class="tab-content">
                <div class="card">
                    <h3>Service Status</h3>
                    <div id="services-status" class="loading">
                        <div class="spinner"></div>
                        <p>Loading services...</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>Infrastructure Status</h3>
                    <div id="infrastructure-status"></div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showCreateUserModal()">Create User</button>
                </div>
                <div class="card">
                    <h3>User List</h3>
                    <div id="users-list" class="loading">
                        <div class="spinner"></div>
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>

            <!-- Audit Tab -->
            <div id="audit" class="tab-content">
                <div class="card">
                    <h3>Audit Logs</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="exportAuditLogs()">Export Logs</button>
                    </div>
                    <div id="audit-logs" class="loading">
                        <div class="spinner"></div>
                        <p>Loading audit logs...</p>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h3>System Settings</h3>
                    <div id="settings-list" class="loading">
                        <div class="spinner"></div>
                        <p>Loading settings...</p>
                    </div>
                </div>
            </div>

            <!-- Backup Tab -->
            <div id="backup" class="tab-content">
                <div class="card">
                    <h3>Backup Management</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="triggerBackup()">Create Backup</button>
                    </div>
                    <div id="backup-list" class="loading">
                        <div class="spinner"></div>
                        <p>Loading backups...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createUserModal')">&times;</span>
            <h2>Create New User</h2>
            <form id="createUserForm" onsubmit="createUser(event)">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" name="password" required>
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select name="role">
                        <option value="viewer">Viewer</option>
                        <option value="surveyor">Surveyor</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                        <option value="superadmin">Superadmin</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Create User</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3007';
        const USER_ID = 'admin'; // This should come from authentication
        const USER_ROLE = 'superadmin';

        // Tab navigation
        document.querySelectorAll('.nav-menu a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = link.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update active nav item
            document.querySelectorAll('.nav-menu a').forEach(a => a.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Update page title
            const titles = {
                'overview': 'Dashboard Overview',
                'health': 'System Health',
                'users': 'User Management',
                'audit': 'Audit Logs',
                'settings': 'System Settings',
                'backup': 'Backup & Restore'
            };
            document.getElementById('page-title').textContent = titles[tabName];

            // Load data for the tab
            loadTabData(tabName);
        }

        async function loadTabData(tab) {
            switch(tab) {
                case 'overview':
                    await loadDashboardOverview();
                    break;
                case 'health':
                    await loadHealthData();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'audit':
                    await loadAuditLogs();
                    break;
                case 'settings':
                    await loadSettings();
                    break;
                case 'backup':
                    await loadBackups();
                    break;
            }
        }

        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'x-user-id': USER_ID,
                'x-user-role': USER_ROLE
            };

            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: { ...headers, ...options.headers }
            });

            if (!response.ok) {
                throw new Error(`API call failed: ${response.statusText}`);
            }

            return await response.json();
        }

        async function loadDashboardOverview() {
            try {
                const data = await apiCall('/admin/stats/dashboard');

                document.getElementById('total-users').textContent = data.data.users.total || 0;
                document.getElementById('active-users').textContent = data.data.users.active || 0;
                document.getElementById('system-status').textContent = data.data.system.status || 'Unknown';
                document.getElementById('cpu-usage').textContent =
                    (data.data.system.cpu || 0).toFixed(1) + '%';

                // Load recent activity
                const activityHtml = data.data.recentActivity.map(log => `
                    <div style="padding: 10px; border-bottom: 1px solid #ecf0f1;">
                        <strong>${log.eventType}</strong> - ${log.action}
                        <div style="font-size: 12px; color: #7f8c8d;">
                            ${new Date(log.timestamp).toLocaleString()}
                        </div>
                    </div>
                `).join('');

                document.getElementById('recent-activity').innerHTML = activityHtml || '<p>No recent activity</p>';
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('recent-activity').innerHTML = '<p>Error loading data</p>';
            }
        }

        async function loadHealthData() {
            try {
                const health = await apiCall('/admin/health');

                // Services status
                const servicesHtml = `
                    <table>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Response Time</th>
                        </tr>
                        ${health.data.services.map(service => `
                            <tr>
                                <td>${service.name}</td>
                                <td>
                                    <span class="status-indicator status-${service.status}"></span>
                                    ${service.status}
                                </td>
                                <td>${service.responseTime}ms</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
                document.getElementById('services-status').innerHTML = servicesHtml;

                // Infrastructure status
                const infra = health.data.infrastructure;
                const infraHtml = `
                    <table>
                        <tr>
                            <th>Component</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                        <tr>
                            <td>MongoDB</td>
                            <td><span class="status-indicator status-${infra.mongodb.status === 'connected' ? 'healthy' : 'unhealthy'}"></span> ${infra.mongodb.status}</td>
                            <td>Connections: ${infra.mongodb.connections || 0}</td>
                        </tr>
                        <tr>
                            <td>Redis</td>
                            <td><span class="status-indicator status-${infra.redis.status === 'connected' ? 'healthy' : 'unhealthy'}"></span> ${infra.redis.status}</td>
                            <td>Memory: ${(infra.redis.memory / 1024 / 1024).toFixed(2)} MB</td>
                        </tr>
                        <tr>
                            <td>Kafka</td>
                            <td><span class="status-indicator status-${infra.kafka.status === 'connected' ? 'healthy' : 'unhealthy'}"></span> ${infra.kafka.status}</td>
                            <td>Brokers: ${infra.kafka.brokers || 0}</td>
                        </tr>
                    </table>
                `;
                document.getElementById('infrastructure-status').innerHTML = infraHtml;
            } catch (error) {
                console.error('Error loading health data:', error);
                document.getElementById('services-status').innerHTML = '<p>Error loading health data</p>';
            }
        }

        async function loadUsers() {
            try {
                const data = await apiCall('/admin/users');

                const usersHtml = `
                    <table>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        ${data.data.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.role}</td>
                                <td>${user.status}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="editUser('${user._id}')">Edit</button>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                `;
                document.getElementById('users-list').innerHTML = usersHtml;
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-list').innerHTML = '<p>Error loading users</p>';
            }
        }

        async function loadAuditLogs() {
            try {
                const data = await apiCall('/admin/audit?limit=50');

                const logsHtml = `
                    <table>
                        <tr>
                            <th>Event Type</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Severity</th>
                            <th>Timestamp</th>
                        </tr>
                        ${data.data.map(log => `
                            <tr>
                                <td>${log.eventType}</td>
                                <td>${log.action}</td>
                                <td>${log.username || log.userId || 'N/A'}</td>
                                <td>${log.severity}</td>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
                document.getElementById('audit-logs').innerHTML = logsHtml;
            } catch (error) {
                console.error('Error loading audit logs:', error);
                document.getElementById('audit-logs').innerHTML = '<p>Error loading audit logs</p>';
            }
        }

        async function loadSettings() {
            try {
                const data = await apiCall('/admin/settings?includeNonPublic=true');

                const settingsHtml = `
                    <table>
                        <tr>
                            <th>Setting</th>
                            <th>Category</th>
                            <th>Value</th>
                            <th>Actions</th>
                        </tr>
                        ${data.data.map(setting => `
                            <tr>
                                <td>${setting.metadata?.displayName || setting.key}</td>
                                <td>${setting.category}</td>
                                <td>${JSON.stringify(setting.value)}</td>
                                <td>
                                    ${setting.isEditable ? '<button class="btn btn-primary">Edit</button>' : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                `;
                document.getElementById('settings-list').innerHTML = settingsHtml;
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('settings-list').innerHTML = '<p>Error loading settings</p>';
            }
        }

        async function loadBackups() {
            try {
                const data = await apiCall('/admin/backup');

                const backupsHtml = data.data.length > 0 ? `
                    <table>
                        <tr>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                        ${data.data.map(backup => `
                            <tr>
                                <td>${backup.fileName}</td>
                                <td>${(backup.fileSize / 1024 / 1024).toFixed(2)} MB</td>
                                <td>${new Date(backup.createdAt).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="restoreBackup('${backup.fileName}')">Restore</button>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                ` : '<p>No backups available</p>';

                document.getElementById('backup-list').innerHTML = backupsHtml;
            } catch (error) {
                console.error('Error loading backups:', error);
                document.getElementById('backup-list').innerHTML = '<p>Error loading backups</p>';
            }
        }

        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function createUser(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userData = Object.fromEntries(formData);

            try {
                await apiCall('/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                alert('User created successfully');
                closeModal('createUserModal');
                loadUsers();
            } catch (error) {
                alert('Error creating user: ' + error.message);
            }
        }

        async function triggerBackup() {
            if (!confirm('Create a new backup? This may take a few minutes.')) return;

            try {
                await apiCall('/admin/backup', { method: 'POST' });
                alert('Backup created successfully');
                loadBackups();
            } catch (error) {
                alert('Error creating backup: ' + error.message);
            }
        }

        async function restoreBackup(fileName) {
            if (!confirm('Restore from backup? This will replace current data!')) return;

            try {
                await apiCall('/admin/backup/restore', {
                    method: 'POST',
                    body: JSON.stringify({ fileName })
                });
                alert('Backup restored successfully');
            } catch (error) {
                alert('Error restoring backup: ' + error.message);
            }
        }

        function exportAuditLogs() {
            window.open(`${API_BASE}/admin/audit/export?format=csv`, '_blank');
        }

        function refreshData() {
            const activeTab = document.querySelector('.tab-content.active').id;
            loadTabData(activeTab);
        }

        // Load initial data
        loadDashboardOverview();
    </script>
</body>
</html>
